name: Pull Proton VPN Server Data

on:
  workflow_dispatch:
  schedule:
    # Run daily at midnight UTC
    - cron: "0 0 * * *"

jobs:
  pull-protonvpn-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create directory if not exists
        run: mkdir -p ExternalData
      
      - name: Fetch and process Proton VPN server data
        run: |
          echo "Fetching Proton VPN server data from public website..."
          
          # Download the page and create a simple parser
          curl -s "https://protonvpn.com/vpn-servers" > proton_page.html
          
          # Debug: Show what we got
          echo "Page size: $(wc -c < proton_page.html) characters"
          echo "Sample content:"
          head -20 proton_page.html
          
          # Create CSV with basic extraction
          echo "Country,ServerCount,Cities,Features" > ExternalData/ProtonVPNServers.csv
          
          # Simple extraction using grep and basic parsing
          grep -E "[0-9]+ servers? \| [0-9]+ cit" proton_page.html | head -10 | while read line; do
            echo "Found line: $line"
            servers=$(echo "$line" | grep -o '[0-9]* servers' | grep -o '[0-9]*' | head -1)
            cities=$(echo "$line" | grep -o '[0-9]* cit' | grep -o '[0-9]*' | head -1)
            echo "Sample,$servers,$cities,Test" >> ExternalData/ProtonVPNServers.csv
          done
          
          # Clean up
          rm -f proton_page.html
          
          # Verify file was created and has content
          if [ ! -s ExternalData/ProtonVPNServers.csv ]; then
            echo "Error: Output file is empty or doesn't exist"
            exit 1
          fi
          
          # Count entries for logging (subtract 1 for header)
          entries=$(($(wc -l < ExternalData/ProtonVPNServers.csv) - 1))
          echo "Processed $entries ProtonVPN server countries"
      
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Proton VPN servers - $(date -u +%Y-%m-%d)"
          file_pattern: 'ExternalData/ProtonVPNServers.csv'
          commit_user_name: 'Proton VPN Data Updater'
          commit_user_email: 'actions@github.com'
          push_options: '--force-with-lease'
