id: cee675fc-37e6-485c-821f-746491b5e5a6
name: Testing - Excessive MFA Denies
description: Excessive MFA Denies
severity: Informational
requiredDataConnectors:
  - connectorId: YourConnectorId
    dataTypes:
      - YourDataType
queryFrequency: P1D
queryPeriod: P14D
triggerOperator: gt
triggerThreshold: 0
status: Disabled
tactics:
  - InitialAccess
techniques:
  - T1078
query: |-
  let threshold = 2;
  let timeWindow = 10m;
  let aadFunc = (tableName:string) {
  table(tableName)
  | where Status has "MFA Denied; user declined the authentication" or Status has "MFA denied; Phone App Reported Fraud"
  | extend Type = Type
  | extend timestamp = TimeGenerated, Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])
  };
  let aadSignin = aadFunc("SigninLogs");
  let aadNonInt = aadFunc("AADNonInteractiveUserSignInLogs");
  let DeniedMFAUsers =
  union isfuzzy=true aadSignin, aadNonInt
  | summarize DeniedAttempts = count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by bin(TimeGenerated, timeWindow), UserPrincipalName, ResultType, CorrelationId, Location
  | where DeniedAttempts >= threshold;
  DeniedMFAUsers
  | extend Severity = case(
  DeniedAttempts < 5, "Medium",
  DeniedAttempts >= 10, "High",
  "High"
  );
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: UserPrincipalName
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: false
    reopenClosedIncident: false
    lookbackDuration: PT5H
    matchingMethod: AllEntities
    groupByEntities: []
    groupByAlertDetails: []
    groupByCustomDetails: []
eventGroupingSettings:
  aggregationKind: SingleAlert
suppressionDuration: PT5H
suppressionEnabled: false
alertDetailsOverride:
  alertSeverityColumnName: Severity
  alertDynamicProperties: []
version: 1.0.0
kind: Scheduled
