id: a6ea8559-a7a5-485a-a555-c978681a27b4
name: Testing - Potential exploitation of CVE-2024-49112 (LDAP Nightmare)
description: |-
  SafeBreach Labs Researchers developed a zero-click PoC exploit that crashes unpatched Windows Servers using the Windows Lightweight Directory Access Protocol (LDAP) remote code execution vulnerability. The below Sentinel KQL check for any possible LDAPNightmare abuse.

  https://www.safebreach.com/blog/ldapnightmare-safebreach-labs-publishes-first-proof-of-concept-exploit-for-cve-2024-49113/
severity: High
requiredDataConnectors:
  - connectorId: YourConnectorId
    dataTypes:
      - YourDataType
queryFrequency: PT1H
queryPeriod: PT1H
triggerOperator: gt
triggerThreshold: 0
status: Disabled
tactics:
  - InitialAccess
  - Execution
  - Discovery
techniques: []
query: |-
  ASimDnsActivityLogs
  | where TimeGenerated > ago(1h)
  | where DnsQuery has "_ldap._tcp.dc._msdcs." or DnsQuery has "_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs."
  | extend LDAPQueryHost = iff((DnsQuery has "_ldap._tcp.dc._msdcs."),
  tostring(split(DnsQuery, "_ldap._tcp.dc._msdcs.", 1)),
  tostring(split(DnsQuery, "_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.", 1)))
  | where isnotempty(LDAPQueryHost)
  | where not (LDAPQueryHost has ".local" or LDAPQueryHost has "workgroup" or LDAPQueryHost has "-DC")
  | where DnsQueryType == "33"
  | where DnsResponseCode == 0
entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: DvcHostname
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: DvcIpAddr
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: false
    reopenClosedIncident: false
    lookbackDuration: PT5H
    matchingMethod: AllEntities
    groupByEntities: []
    groupByAlertDetails: []
    groupByCustomDetails: []
eventGroupingSettings:
  aggregationKind: SingleAlert
suppressionDuration: PT5H
suppressionEnabled: false
version: 1.0.0
kind: Scheduled
