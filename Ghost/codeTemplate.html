<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
// Unified Code Embed for Ghost
(function() {
    // Add CSS styles
    const style = document.createElement('style');
    style.textContent = `
        .code-embed-container {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 8px;
            max-height: 600px;
            margin: 20px 0;
            border: 1px solid;
            background-color: #f6f8fa !important;
            color: #24292f !important;
            border-color: #d1d9e0 !important;
            display: flex;
            flex-direction: column;
        }

        .code-embed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: #f6f8fa;
            flex-shrink: 0;
        }

        .code-embed-content {
            padding: 0;
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
        }

        .code-embed-content pre {
            margin: 0;
            padding: 20px;
            background: transparent !important;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            white-space: pre;
            overflow: visible;
            color: #24292f !important;
        }

        .code-embed-content code {
            background: transparent !important;
            padding: 0;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
        }

        .code-embed-indicator {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-embed-copy {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: inherit;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .code-embed-copy:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .code-embed-copy.success {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .code-embed-loading {
            padding: 20px;
            text-align: center;
            font-style: italic;
            opacity: 0.7;
        }

        .code-embed-content::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .code-embed-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .code-embed-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #cbd5e0, #a0aec0);
            border-radius: 6px;
            border: 2px solid #f6f8fa;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .code-embed-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #a0aec0, #718096);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .code-embed-content::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #718096, #4a5568);
        }

        .code-embed-content::-webkit-scrollbar-corner {
            background: transparent;
        }

        .code-embed-content {
            scrollbar-width: auto;
            scrollbar-color: #cbd5e0 transparent;
        }

        @media (prefers-color-scheme: dark) {
            .code-embed-container {
                background-color: #161b22 !important;
                color: #e6edf3 !important;
                border-color: #30363d !important;
            }
            .code-embed-header {
                background: #161b22;
            }
            .code-embed-content::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #4a5568, #2d3748);
                border: 2px solid #161b22;
                box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1);
            }
            .code-embed-content::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #2d3748, #1a202c);
                box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.2);
            }
            .code-embed-content::-webkit-scrollbar-thumb:active {
                background: linear-gradient(180deg, #1a202c, #171923);
            }
            .code-embed-content pre {
                color: #e6edf3 !important;
            }
        }

        .dark .code-embed-container,
        [data-theme="dark"] .code-embed-container,
        body.dark .code-embed-container {
            background-color: #161b22 !important;
            color: #e6edf3 !important;
            border-color: #30363d !important;
        }

        .dark .code-embed-header,
        [data-theme="dark"] .code-embed-header,
        body.dark .code-embed-header {
            background: #161b22;
        }

        .dark .code-embed-content::-webkit-scrollbar-thumb,
        [data-theme="dark"] .code-embed-content::-webkit-scrollbar-thumb,
        body.dark .code-embed-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4a5568, #2d3748);
            border: 2px solid #161b22;
        }

        .dark .code-embed-content,
        [data-theme="dark"] .code-embed-content,
        body.dark .code-embed-content {
            scrollbar-color: #4a5568 transparent;
        }

        .dark .code-embed-content pre,
        [data-theme="dark"] .code-embed-content pre,
        body.dark .code-embed-content pre {
            color: #e6edf3 !important;
        }
    `;
    document.head.appendChild(style);

    // Initialize code embeds when DOM is ready
    function initCodeEmbeds() {
        const containers = document.querySelectorAll('.code-embed-container[data-url]:not(.initialized)');
        
        containers.forEach(container => {
            container.classList.add('initialized');
            
            const githubUrl = container.getAttribute('data-url');
            const codeType = container.getAttribute('data-type') || 'auto';
            
            if (!githubUrl) {
                container.innerHTML = '<div style="color: red; padding: 20px;">Error: No URL specified. Add data-url attribute.</div>';
                return;
            }

            let rawCodeContent = '';

            function detectCodeType(url) {
                if (codeType !== 'auto') return codeType;
                
                const extension = url.split('.').pop().toLowerCase();
                switch (extension) {
                    case 'ps1':
                    case 'psm1':
                        return 'powershell';
                    case 'json':
                        return 'json';
                    case 'kql':
                    case 'kusto':
                        return 'kql';
                    case 'yaml':
                    case 'yml':
                        return 'yaml';
                    case 'bicep':
                        return 'bicep';
                    case 'arm':
                    case 'template':
                        return 'json';
                    default:
                        return 'text';
                }
            }

            function getLanguageInfo(type) {
                const languages = {
                    'powershell': { display: 'PowerShell', prism: 'language-powershell' },
                    'json': { display: 'JSON', prism: 'language-json' },
                    'kql': { display: 'KQL', prism: 'language-kusto' },
                    'yaml': { display: 'YAML', prism: 'language-yaml' },
                    'bicep': { display: 'Bicep', prism: 'language-bicep' },
                    'text': { display: 'Text', prism: 'language-text' }
                };
                return languages[type] || languages['text'];
            }

            function copyCode() {
                const copyBtn = container.querySelector('.code-embed-copy');
                navigator.clipboard.writeText(rawCodeContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('success');
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                        copyBtn.classList.remove('success');
                    }, 2000);
                }).catch(() => {
                    copyBtn.textContent = 'Error';
                    setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                });
            }

            function formatContent(data, type) {
                if (type === 'json') {
                    try {
                        return JSON.stringify(JSON.parse(data), null, 2);
                    } catch (e) {
                        return data;
                    }
                }
                return data;
            }

            container.innerHTML = '<div class="code-embed-loading">Loading code...</div>';

            const detectedType = detectCodeType(githubUrl);
            const langInfo = getLanguageInfo(detectedType);

            fetch(githubUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(data => {
                    rawCodeContent = data;
                    const formattedContent = formatContent(data, detectedType);
                    
                    container.innerHTML = `
                        <div class="code-embed-header">
                            <div class="code-embed-indicator">${langInfo.display}</div>
                            <button class="code-embed-copy">Copy</button>
                        </div>
                        <div class="code-embed-content">
                            <pre><code class="${langInfo.prism}">${formattedContent.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/&/g, '&amp;')}</code></pre>
                        </div>
                    `;
                    container.querySelector('.code-embed-copy').addEventListener('click', copyCode);
                    
                    // Trigger Prism.js highlighting if available
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAllUnder(container);
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div style="color: red; padding: 20px;">Error loading ${githubUrl}: ${error.message}</div>`;
                });
        });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCodeEmbeds);
    } else {
        initCodeEmbeds();
    }

    // Also initialize when new content is added (for dynamic content)
    const observer = new MutationObserver(initCodeEmbeds);
    observer.observe(document.body, { childList: true, subtree: true });
})();
</script>